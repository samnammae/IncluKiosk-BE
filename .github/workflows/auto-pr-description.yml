name: Gemini PR Auto-Description

on:
  pull_request:
    types: [opened]

jobs:
  gemini-summarize:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate Summary and Update PR
        uses: actions/github-script@v7
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        with:
          script: |
            const { execSync } = require('child_process');

            // 1. git diff ì¶”ì¶œ (ìµœëŒ€ 4000ì ì œí•œ ë° ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬)
            let diff = "";
            try {
              diff = execSync('git diff origin/${{ github.base_ref }}...HEAD | head -c 4000').toString();
            } catch (e) {
              console.log("Diff extraction failed:", e);
              diff = "diffë¥¼ ì¶”ì¶œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
            }

            // 2. Gemini API í˜¸ì¶œ
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${process.env.GEMINI_API_KEY}`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                contents: [{
                  parts: [{
                    text: `ë„ˆëŠ” ì‹œë‹ˆì–´ ì†Œí”„íŠ¸ì›¨ì–´ ì—”ì§€ë‹ˆì–´ë‹¤. ë‹¤ìŒ git diff ë³€ê²½ ì‚¬í•­ì„ ë¶„ì„í•˜ì—¬ PR ìš”ì•½ë¬¸ì„ í•œêµ­ì–´ë¡œ ì‘ì„±í•´ë¼. 
                    í˜•ì‹ì€ 'ë³€ê²½ ëª©ì 'ê³¼ 'í•µì‹¬ ë³€ê²½ ì‚¬í•­'ì„ í¬í•¨í•´ì•¼ í•œë‹¤.
                    
                    ë³€ê²½ ì‚¬í•­:
                    ${diff}`
                  }]
                }],
                // ì•ˆì „ ì„¤ì • ì™„í™”: ì½”ë“œ ë¶„ì„ ì¤‘ ì˜¤íƒì§€ë¡œ ì¸í•œ ì°¨ë‹¨ ë°©ì§€
                safetySettings: [
                  { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                  { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                  { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                  { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
                ],
                generationConfig: {
                  maxOutputTokens: 1000,
                  temperature: 0.7
                }
              })
            });

            const data = await response.json();
            
            // 3. ì‘ë‹µ ë°ì´í„° ë¶„ì„ ë° ì—ëŸ¬ í•¸ë“¤ë§
            let summary = "";
            if (data.candidates && data.candidates[0].content && data.candidates[0].content.parts) {
              summary = data.candidates[0].content.parts[0].text;
            } else {
              console.log("Full API Response:", JSON.stringify(data));
              if (data.error) {
                summary = `âš ï¸ API ì—ëŸ¬: ${data.error.message}`;
              } else if (data.promptFeedback && data.promptFeedback.blockReason) {
                summary = `ğŸš« ì½˜í…ì¸ ê°€ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. (ì‚¬ìœ : ${data.promptFeedback.blockReason})`;
              } else {
                summary = "ğŸ¤– Geminiê°€ ìš”ì•½ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìƒì„¸ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.";
              }
            }

            // 4. PR ë³¸ë¬¸ ì—…ë°ì´íŠ¸
            const footer = "\n\n----- \n> âœ¨ **Gemini**ì— ì˜í•´ ìë™ ìƒì„±ëœ ìš”ì•½ì…ë‹ˆë‹¤. í•„ìš”ì— ë”°ë¼ ìˆ˜ì •í•˜ì„¸ìš”!";
            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              body: summary + footer
            });
