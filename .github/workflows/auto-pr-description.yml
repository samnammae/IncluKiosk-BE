name: Gemini PR Auto-Description

on:
  pull_request:
    types: [opened] # 처음 생성될 때만 실행 (내가 수정해도 덮어쓰지 않음)

jobs:
  gemini-summarize:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get Git Diff
        id: get_diff
        run: |
          # diff 결과를 파일로 저장
          git diff origin/${{ github.base_ref }}...HEAD > diff.txt
          
          # 환경 변수에 멀티라인 데이터를 안전하게 저장하는 방식
          echo "DIFF_CONTENT<<EOF" >> $GITHUB_ENV
          cat diff.txt | head -c 4000 >> $GITHUB_ENV
          echo "" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Call Gemini API
        id: gemini
        run: |
          # Gemini API 호출 (curl 사용)
          RESPONSE=$(curl -X POST "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${{ secrets.GEMINI_API_KEY }}" \
          -H "Content-Type: application/json" \
          -d '{
            "contents": [{
              "parts": [{
                "text": "너는 유능한 개발자야. 다음 코드가 변경된 내용(git diff)을 보고 PR 본문에 들어갈 요약문을 작성해줘. 형식은 마크다운을 사용하고, 변경 목적과 주요 변경 사항을 불렛 포인트로 정리해줘. 한국어로 작성해.\n\n${{ env.DIFF_CONTENT }}"
              }]
            }]
          }')
          
          # 응답값에서 텍스트만 추출 (jq 활용)
          echo "SUMMARY=$(echo $RESPONSE | jq -r '.candidates[0].content.parts[0].text')" >> $GITHUB_ENV

      - name: Update PR Body
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const summary = process.env.SUMMARY;
            const footer = "\n\n---\n> ✨ **Gemini**에 의해 자동 생성된 요약입니다. 필요에 따라 수정하세요!";
            
            github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              body: summary + footer
            });
