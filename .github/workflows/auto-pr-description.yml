name: Gemini PR Auto-Description

on:
  pull_request:
    types: [opened]

jobs:
  gemini-summarize:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate Summary and Update PR
        uses: actions/github-script@v7
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        with:
          script: |
            const { execSync } = require('child_process');

            // 1. git diff 추출 (최대 4000자)
            const diff = execSync('git diff origin/${{ github.base_ref }}...HEAD | head -c 4000').toString();

            // 2. Gemini API 호출
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${process.env.GEMINI_API_KEY}`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                contents: [{
                  parts: [{
                    text: `너는 유능한 개발자야. 다음 git diff 내용을 보고 PR 요약문을 작성해줘. 한국어로 작성하고 변경 목적과 주요 변경 사항을 정리해줘.\n\n${diff}`
                  }]
                }]
              })
            });

            const data = await response.json();
            
            // 3. 응답 데이터 확인 및 추출
            let summary = "요약을 생성할 수 없습니다.";
            if (data.candidates && data.candidates[0].content && data.candidates[0].content.parts) {
              summary = data.candidates[0].content.parts[0].text;
            } else {
              console.log("API Response Error:", JSON.stringify(data));
              summary = "Gemini API 응답 형식이 올바르지 않습니다.";
            }

            // 4. PR 본문 업데이트
            const footer = "\n\n----- \n> ✨ **Gemini**에 의해 자동 생성된 요약입니다. 필요에 따라 수정하세요!";
            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              body: summary + footer
            });
