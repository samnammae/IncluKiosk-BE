name: Gemini PR Auto-Description

on:
  pull_request:
    types: [opened]

jobs:
  gemini-summarize:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate Summary and Update PR
        uses: actions/github-script@v7
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        with:
          script: |
            const { execSync } = require('child_process');

            // 1. git diff ì¶”ì¶œ (ìµœëŒ€ 4000ì ì œí•œ)
            let diff = "";
            try {
              diff = execSync('git diff origin/${{ github.base_ref }}...HEAD | head -c 4000').toString();
            } catch (e) {
              console.log("Diff extraction failed:", e);
              diff = "diffë¥¼ ì¶”ì¶œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
            }

            // 2. Gemini API í˜¸ì¶œ (ê³µì‹ ë¬¸ì„œ ê·œê²© ë°˜ì˜)
            const model = "gemini-3-flash-preview";
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent`;

            try {
              const response = await fetch(url, {
                method: 'POST',
                headers: { 
                  'Content-Type': 'application/json',
                  'x-goog-api-key': process.env.GEMINI_API_KEY
                },
                body: JSON.stringify({
                  contents: [{
                    parts: [{
                      text: `ë„ˆëŠ” ì‹œë‹ˆì–´ ì†Œí”„íŠ¸ì›¨ì–´ ì—”ì§€ë‹ˆì–´ë‹¤. ë‹¤ìŒ git diff ë³€ê²½ ì‚¬í•­ì„ ë¶„ì„í•˜ì—¬ PR ìš”ì•½ë¬¸ì„ í•œêµ­ì–´ë¡œ ì‘ì„±í•´ë¼. í˜•ì‹ì€ 'ë³€ê²½ ëª©ì 'ê³¼ 'í•µì‹¬ ë³€ê²½ ì‚¬í•­'ì„ í¬í•¨í•´ì•¼ í•œë‹¤.\n\n${diff}`
                    }]
                  }],
                  generationConfig: {
                    maxOutputTokens: 1000,
                    temperature: 0.7
                  }
                })
              });

              const data = await response.json();
              
              // 3. ì‘ë‹µ ë°ì´í„° ì²˜ë¦¬ ë° ìš”ì•½ ì¶”ì¶œ
              let summary = "";
              if (data.candidates && data.candidates[0].content && data.candidates[0].content.parts) {
                summary = data.candidates[0].content.parts[0].text;
              } else {
                console.log("API Error Response:", JSON.stringify(data));
                summary = data.error ? `âš ï¸ API ì—ëŸ¬: ${data.error.message}` : "ğŸ¤– ìš”ì•½ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (API ì‘ë‹µ êµ¬ì¡° í™•ì¸ í•„ìš”)";
              }

              // 4. PR ë³¸ë¬¸ ì—…ë°ì´íŠ¸
              const footer = "\n\n----- \n> âœ¨ **Gemini 3 Flash**ì— ì˜í•´ ìë™ ìƒì„±ëœ ìš”ì•½ì…ë‹ˆë‹¤. í•„ìš”ì— ë”°ë¼ ìˆ˜ì •í•˜ì„¸ìš”!";
              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.payload.pull_request.number,
                body: summary + footer
              });

            } catch (error) {
              console.log("Network or Script Error:", error);
            }
