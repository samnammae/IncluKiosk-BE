name: Gemini PR Auto-Description

on:
  pull_request:
    types: [opened]

jobs:
  gemini-summarize:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get Git Diff
        id: get_diff
        run: |
          # 1. diff 결과 추출 및 4000자 제한
          git diff origin/${{ github.base_ref }}...HEAD | head -c 4000 > diff_content.txt
          
          # 2. 멀티라인 환경 변수 저장 (핵심 해결책)
          echo "DIFF_CONTENT<<EOF" >> $GITHUB_ENV
          cat diff_content.txt >> $GITHUB_ENV
          echo "" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Call Gemini API
        id: gemini
        run: |
          # 1. API 호출 및 응답 저장
          RESPONSE=$(curl -X POST "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${{ secrets.GEMINI_API_KEY }}" \
          -H "Content-Type: application/json" \
          -d "{
            \"contents\": [{
              \"parts\": [{
                \"text\": \"다음 git diff 내용을 보고 PR 요약문을 작성해줘. 한국어로 작성하고 변경 목적과 주요 변경 사항을 정리해줘.\n\n$(cat diff_content.txt | python3 -c 'import json,sys; print(json.dumps(sys.stdin.read()))')\"
              }]
            }]
          }")

          # 2. 응답에서 텍스트 추출 (jq로 안전하게 추출)
          SUMMARY=$(echo "$RESPONSE" | jq -r '.candidates[0].content.parts[0].text')
          
          # 3. SUMMARY 변수도 멀티라인으로 저장
          echo "SUMMARY<<EOF" >> $GITHUB_ENV
          echo "$SUMMARY" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Update PR Body
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const summary = process.env.SUMMARY;
            const footer = "\n\n----- \n> ✨ **Gemini**에 의해 자동 생성된 요약입니다. 필요에 따라 수정하세요!";
            
            github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              body: summary + footer
            });